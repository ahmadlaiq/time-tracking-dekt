<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  </head>
  <body class="font-sans p-5 bg-gray-100">
    <div id="app">
      <!-- Login Form -->
      <div
        v-if="!isLoggedIn"
        class="max-w-md mx-auto mt-10 p-6 bg-white shadow-md rounded-md"
      >
        <h2 class="text-2xl font-bold mb-4">Login</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Email:</label>
          <input
            type="email"
            v-model="loginForm.email"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Password:</label>
          <input
            type="password"
            v-model="loginForm.password"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <button
          @click="login"
          class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600 transition"
        >
          Login
        </button>
        <div v-if="error" class="text-red-500 mt-4">{{ error }}</div>
      </div>

      <!-- Main App -->
      <div v-else>
        <!-- User Info -->
        <div class="bg-white p-4 shadow-md rounded-md mb-4">
          <h3 class="text-lg font-bold">Welcome, {{ user.name }}</h3>
          <button
            @click="logout"
            class="mt-2 bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition"
          >
            Logout
          </button>
        </div>

        <!-- Task Selection -->
        <select
          v-model="selectedTask"
          class="block w-52 mx-auto p-2 border border-gray-300 rounded-md mb-6"
        >
          <option value="">Select Task</option>
          <option v-for="task in user.task" :key="task.id" :value="task">
            {{ task.name }}
          </option>
        </select>

        <div class="text-center text-4xl font-bold mb-6">{{ formatTime }}</div>
        <div class="flex justify-center space-x-4 mb-6">
          <button
            @click="startTimer"
            :disabled="isRunning || !selectedTask"
            class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            Start
          </button>
          <button
            @click="pauseTimer"
            :disabled="!isRunning || isPaused"
            class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            Pause
          </button>
          <button
            @click="stopTimer"
            :disabled="!isRunning"
            class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            Stop
          </button>
        </div>

        <div v-if="error" class="text-red-500 text-center">{{ error }}</div>

        <!-- Current Session -->
        <div
          v-if="currentSession"
          class="bg-white p-4 shadow-md rounded-md mb-6"
        >
          <h3 class="text-lg font-bold">Current Session</h3>
          <p>Session ID: {{ currentSession.id }}</p>
          <p>Task: {{ selectedTask.name }}</p>
          <p>Duration: {{ formatDuration(time) }}</p>
        </div>

        <!-- Session History -->
        <div v-if="sessions.length > 0">
          <h3 class="text-xl font-bold mb-4">Session History:</h3>
          <div
            v-for="(session, index) in sessions"
            :key="session.id"
            class="bg-white p-4 shadow-md rounded-md mb-4"
          >
            <p>Session {{ index + 1 }}</p>
            <p>Task: {{ session.taskName }}</p>
            <p>Duration: {{ formatDuration(session.duration) }}</p>
            <div v-if="session.screenshots && session.screenshots.length">
              <p>Screenshots: {{ session.screenshots.length }}</p>
              <img
                v-for="screenshot in session.screenshots"
                :key="screenshot.id"
                :src="`http://139.59.249.111:3000/${screenshot.path}`"
                class="w-48 h-auto mt-2"
                @error="handleImageError"
              />
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");
      const API_URL = process.env.API_URL;
      const app = Vue.createApp({
        data() {
          return {
            loginForm: {
              email: "",
              password: "",
            },
            isLoggedIn: false,
            user: null,
            token: null,
            selectedTask: null,
            time: 0,
            timer: null,
            isRunning: false,
            isPaused: false,
            sessions: [],
            currentSession: null,
            screenshotInterval: null,
            error: null,
          };
        },
        created() {
          // Check for stored authentication
          const storedAuth = localStorage.getItem("auth");
          if (storedAuth) {
            const auth = JSON.parse(storedAuth);
            this.user = auth.user;
            this.token = auth.token;
            this.isLoggedIn = true;
          }
        },
        computed: {
          formatTime() {
            const hours = Math.floor(this.time / 3600);
            const minutes = Math.floor((this.time % 3600) / 60);
            const seconds = this.time % 60;
            return `${String(hours).padStart(2, "0")}:${String(
              minutes
            ).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
          },
        },
        methods: {
          async login() {
            try {
              const response = await fetch(`${API_URL}/api/v1/login`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(this.loginForm),
              });

              const result = await response.json();

              if (result.success) {
                this.user = result.data.user;
                this.token = result.data.token;
                this.isLoggedIn = true;
                this.error = null;

                // Store authentication
                localStorage.setItem(
                  "auth",
                  JSON.stringify({
                    user: this.user,
                    token: this.token,
                  })
                );
              } else {
                this.error = result.message;
              }
            } catch (error) {
              this.error = "Login failed: " + error.message;
              console.error("Login error:", error);
            }
          },
          logout() {
            this.isLoggedIn = false;
            this.user = null;
            this.token = null;
            this.selectedTask = null;
            localStorage.removeItem("auth");
            this.resetTimer();
          },
          async startTimer() {
            if (!this.isRunning && this.selectedTask) {
              try {
                const response = await fetch(`${API_URL}/api/v1/track-time`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${this.token}`,
                  },
                  body: JSON.stringify({
                    duration: 0,
                    taskId: this.selectedTask.id,
                    userId: this.user.id,
                  }),
                });

                const session = await response.json();
                this.currentSession = session;

                this.isRunning = true;
                this.isPaused = false;
                this.error = null;

                this.timer = setInterval(() => {
                  this.time++;
                }, 1000);

                // Ambil screenshot setiap 30 detik
                this.screenshotInterval = setInterval(async () => {
                  await this.takeScreenshot();
                }, 30000); // 30 detik
              } catch (error) {
                this.error = "Failed to start session: " + error.message;
                console.error("Error starting session:", error);
              }
            }
          },
          pauseTimer() {
            if (this.isRunning && !this.isPaused) {
              clearInterval(this.timer);
              clearInterval(this.screenshotInterval);
              this.isPaused = true;
            }
          },
          async stopTimer() {
            if (this.isRunning || this.isPaused) {
              this.isRunning = false;
              this.isPaused = false;
              try {
                clearInterval(this.timer);
                clearInterval(this.screenshotInterval);

                await fetch(`${API_URL}/api/v1/track-time`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${this.token}`,
                  },
                  body: JSON.stringify({
                    id: this.currentSession.id,
                    duration: this.time,
                    taskId: this.selectedTask.id,
                    userId: this.user.id,
                  }),
                });

                // Ambil screenshot terakhir
                await this.takeScreenshot();

                this.sessions.unshift({
                  ...this.currentSession,
                  duration: this.time,
                });

                this.isRunning = false;
                this.currentSession = null;
                this.error = null;
              } catch (error) {
                this.error = "Failed to stop session: " + error.message;
                console.error("Error stopping session:", error);
              }
            }
          },
          formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours}h ${minutes}m ${secs}s`;
          },
          async takeScreenshot() {
            if (!this.currentSession) return;

            try {
              await ipcRenderer.invoke(
                "capture-screenshot",
                this.currentSession.id
              );
            } catch (error) {
              console.error("Failed to take screenshot:", error);
              this.error = "Failed to take screenshot: " + error.message;
            }
          },
          handleImageError(event) {
            event.target.style.display = "none";
          },
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
